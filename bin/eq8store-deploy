#!/usr/bin/env node

'use strict';

const program = require('commander');

const pkg = require('../package.json');

/**
 * Program Options
 */
program
	.description('Deploys an eq8store stack in Docker')
  .version(pkg.version)
	.option('--stack-name', 'The eq8store stack name to deploy in Docker')
	.option('--http-port <num>', 'HTTP service port', parseInt)
	.option('--amqp-port <num>', 'AMQP service port', parseInt)
	.option('--docker-host <uri>', 'Docker host to connect to')
	.option('--disable-amqp', 'Disable and use an external AMQP service')
	.option('--amqp-dsn <uri>', 'Required if `--disable-amqp` is on')
	.option('--tls', 'Use TLS')
	.option('--tlscert <path>', 'Path to TLS certificate file - e.g. /opt/eq8store/cert.pem')
	.option('--tlskey <path>', 'Path to TLS key file - e.g. /opt/eq8store/key.pem')
	.option('--replicas <num>', 'Number of worker replicas to create', parseInt)
  .parse(process.argv);

const _ = require('lodash');
const options = _.pick(program, [
	'httpPort',
	'amqpPort',
	'dockerHost'
]);

const defaults = require('../defaults.json');
const env = _.defaultsDeep(Object.create(process.env), {
	HTTP_PORT: options.httpPort,
	AMQP_PORT: options.amqpPort,
	DOCKER_HOST: options.dockerHost
}, defaults);

const spawn = require('child_process').spawn;

const path = require('path');
const composeFilepath = path.join(__dirname, '../docker-compose.yml');

const deploy = spawn('docker-compose', ['-f', composeFilepath, 'up', '-d'], { env });

deploy.stdout.on('data', data => {
	process.stdout.write(data);
});

deploy.stderr.on('data', data => {
	process.stderr.write(data);
});

deploy.on('close', code => {
	process.exit(code);
});
